# =========================================
# Review Security Pro
# =========================================

WordPress + Contact Form 7 用
フォーム防御・スコア判定・ログ管理統合プラグイン

------------------------------------------
■ サイト情報
------------------------------------------

サイトURL:
https://review-template.com

サーバー:
Ubuntu (VPS)

Webサーバー:
Nginx

PHP:
8.x

WordPress:
有効

使用プラグイン:
- Contact Form 7
- Flamingo
- Review Security Pro（自作）


------------------------------------------
■ ディレクトリ構成
------------------------------------------

/var/www/review-template.com/

├── wp-content/
│   ├── plugins/
│   │   └── review-security-pro/
│   │       ├── review-security-pro.php
│   │       └── rsp.js
│   │
│   ├── themes/
│   │   └── newsblogger/
│   │
│   └── debug.log
│
├── wp-config.php
└── index.php


------------------------------------------
■ プラグインファイル
------------------------------------------

メインファイル:
/wp-content/plugins/review-security-pro/review-security-pro.php

LP用JS:
/wp-content/plugins/review-security-pro/rsp.js


------------------------------------------
■ データベース情報
------------------------------------------

※ wp-config.php に記載

確認場所:
/var/www/review-template.com/wp-config.php

設定値例:

define('DB_NAME', 'データベース名');
define('DB_USER', 'DBユーザー名');
define('DB_PASSWORD', 'DBパスワード');
define('DB_HOST', 'localhost');


------------------------------------------
■ ログイン方法（DB）
------------------------------------------

SSHログイン後:

mysql -u DB_USER -p

パスワード入力

使用DB選択:

USE DB_NAME;


------------------------------------------
■ 使用テーブル
------------------------------------------

1) ブラックリスト保存先

wp_options
option_name = rsp_ip_blacklist


2) フォームログ保存テーブル

wp_form_submission_logs

構造:

id
ip_address
user_agent
referrer
source
risk_score
memo (名前 / メール)
created_at


------------------------------------------
■ セッション管理
------------------------------------------

$_SESSION['rsp_lp_token']
$_SESSION['rsp_lp_time']
$_SESSION['rsp_lp_ip']
$_SESSION['rsp_start_time']


------------------------------------------
■ 現在の機能
------------------------------------------

✔ LP経由チェック（5分有効）
✔ 入力時間判定（3秒未満）
✔ JS nonce検証
✔ REST直叩き検知
✔ Accept-Language検知
✔ 3分3回レート制限
✔ 郵便番号存在チェック（zipcloud）
✔ スコアリングシステム
✔ 管理画面ログ表示
✔ ブラックリスト管理
✔ 詳細ページ表示
✔ メール振り分け
✔ ユーザーUXは変更なし


------------------------------------------
■ スコア判定基準
------------------------------------------


■ 現在の機能一覧
① LP経由判定

LPテンプレート（template-lp.php）経由か確認

セッション管理

5分以内有効

② 入力時間判定

3秒未満送信は疑い

③ JSトークン検証

nonce検証

REST直叩き検知

④ 回数制限

3分以内3回でフラグ

⑤ 郵便番号存在チェック

zipcloud API使用

弾かずスコア加点のみ

⑥ Accept-Language判定

ヘッダー無しを検知

⑦ スコアリングシステム
条件	加点
LP未経由	+2
ブラックIP	+3
回数制限	+1
入力速すぎ	+2
REST直叩き	+3
JS無効	+3
郵便番号不正	+1
判定基準
スコア	判定
0-2	正常
3-4	⚠ 要確認
5以上	🚨 危険
⑧ メール振り分け

危険判定 → spam@review-template.com

管理者メールのみ分岐

ユーザーリターンメールは通常送信


------------------------------------------
■ スコア判定基準
------------------------------------------

0-2    正常
3-4    ⚠ 要確認
5以上  🚨 危険


------------------------------------------
■ メール処理仕様
------------------------------------------

管理者メールのみ振り分け

危険 or スコア3以上:
→ spam@review-template.com

ユーザーリターンメール:
→ 常に通常送信


------------------------------------------
■ デバッグログ確認
------------------------------------------

/var/www/review-template.com/wp-content/debug.log

表示コマンド:

tail -n 50 wp-content/debug.log


------------------------------------------
■ 現在の進捗
------------------------------------------

✔ 判定動作確認済み
✔ ログ保存正常
✔ 名前/メール保存正常
✔ スコア表示正常
✔ ブラックリスト登録正常
✔ 詳細ページ動作確認済み
✔ 迷惑メール対策済み


------------------------------------------
■ 今後の拡張予定
------------------------------------------

- 自動ブラックリスト化
- ISP判定（GeoIP導入時）
- 国判定
- CSVエクスポート
- 統計ダッシュボード
- 同一IP多重検知


------------------------------------------
■ 設計思想
------------------------------------------

送信は止めない
UXを崩さない
裏で判定する
後から精査できる


# =========================================
# END
# =========================================